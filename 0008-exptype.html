<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0008-exptype - JMESPath Enhancement Proposals</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="overview.html">Overview</a></li><li class="chapter-item expanded affix "><a href="0001-nested-expressions.html">0001-nested-expressions</a></li><li class="chapter-item expanded affix "><a href="0003-functions.html">0003-functions</a></li><li class="chapter-item expanded affix "><a href="0004-pipes.html">0004-pipes</a></li><li class="chapter-item expanded affix "><a href="0005-array-slices.html">0005-array-slices</a></li><li class="chapter-item expanded affix "><a href="0006-improved-identifiers.html">0006-improved-identifiers</a></li><li class="chapter-item expanded affix "><a href="0007-filter-expressions.html">0007-filter-expressions</a></li><li class="chapter-item expanded affix "><a href="0008-exptype.html" class="active">0008-exptype</a></li><li class="chapter-item expanded affix "><a href="0009-improved.filters.html">0009-improved.filters</a></li><li class="chapter-item expanded affix "><a href="0010-slice-projects.html">0010-slice-projects</a></li><li class="chapter-item expanded affix "><a href="0011-let-function.html">0011-let-function</a></li><li class="chapter-item expanded affix "><a href="0012-raw-string-literals.html">0012-raw-string-literals</a></li><li class="chapter-item expanded affix "><a href="0018-lexical-scope.html">0018-lexical-scope</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">JMESPath Enhancement Proposals</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="expression-types"><a class="header" href="#expression-types">Expression Types</a></h1>
<ul>
<li>JEP: 8</li>
<li>Author: James Saryerwinnie</li>
<li>Created: 2013-03-02</li>
</ul>
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>This JEP proposes grammar modifications to JMESPath to allow for
expression references within functions.  This allows for functions
such as <code>sort_by</code>, <code>max_by</code>, <code>min_by</code>.  These functions take
an argument that resolves to an expression type.  This enables
functionality such as sorting an array based on an expression that
is evaluated against every array element.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>A useful feature that is common in other expression languages is the
ability to sort a JSON object based on a particular key.  For example,
given a JSON object:</p>
<pre><code>{
  &quot;people&quot;: [
       {&quot;age&quot;: 20, &quot;age_str&quot;: &quot;20&quot;, &quot;bool&quot;: true, &quot;name&quot;: &quot;a&quot;, &quot;extra&quot;: &quot;foo&quot;},
       {&quot;age&quot;: 40, &quot;age_str&quot;: &quot;40&quot;, &quot;bool&quot;: false, &quot;name&quot;: &quot;b&quot;, &quot;extra&quot;: &quot;bar&quot;},
       {&quot;age&quot;: 30, &quot;age_str&quot;: &quot;30&quot;, &quot;bool&quot;: true, &quot;name&quot;: &quot;c&quot;},
       {&quot;age&quot;: 50, &quot;age_str&quot;: &quot;50&quot;, &quot;bool&quot;: false, &quot;name&quot;: &quot;d&quot;},
       {&quot;age&quot;: 10, &quot;age_str&quot;: &quot;10&quot;, &quot;bool&quot;: true, &quot;name&quot;: 3}
  ]
}
</code></pre>
<p>It is not currently possible to sort the <code>people</code> array by the <code>age</code> key.
Also, <code>sort</code> is not defined for the <code>object</code> type, so it’s not currently
possible to even sort the <code>people</code> array.  In order to sort the <code>people</code>
array, we need to know what key to use when sorting the array.</p>
<p>This concept of sorting based on a key can be generalized.  Instead of
requiring a key name, an expression can be provided that each element
would be evaluated against.  In the simplest case, this expression would just
be an <code>identifier</code>, but more complex expressions could be used such as
<code>foo.bar.baz</code>.</p>
<p>A simple way to accomplish this might be to create a function like this:</p>
<pre><code>sort_by(array arg1, expression)

# Called like:

sort_by(people, age)
sort_by(people, to_number(age_str))
</code></pre>
<p>However, there’s a problem with the <code>sort_by</code> function as defined above.
If we follow the function argument resolution process we get:</p>
<pre><code>sort_by(people, age)

# 1. resolve people
arg1 = search(people, &lt;input data&gt;) -&gt; [{&quot;age&quot;: ...}, {...}]

# 2. resolve age
arg2 = search(age, &lt;input data&gt;) -&gt; null

sort_by([{&quot;age&quot;: ...}, {...}], null)
</code></pre>
<p>The second argument is evaluated against the current node and the expression
<code>age</code> will resolve to <code>null</code> because the input data has no <code>age</code> key.
There needs to be some way to specify that an expression should evaluate to
an expression type:</p>
<pre><code>arg = search(&lt;some expression&gt;, &lt;input data&gt;) -&gt; &lt;expression: age&gt;
</code></pre>
<p>Then the function definition of <code>sort_by</code> would be:</p>
<pre><code>sort_by(array arg1, expression arg2)
</code></pre>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<p>The following grammar rules will be updated to:</p>
<pre><code>function-arg        = expression /
                      current-node /
                      &quot;&amp;&quot; expression
</code></pre>
<p>Evaluating an expression reference should return an object of type
“expression”.  The list of data types supported by a function will now be:</p>
<ul>
<li>
<p>number (integers and double-precision floating-point format in JSON)</p>
</li>
<li>
<p>string</p>
</li>
<li>
<p>boolean (<code>true</code> or <code>false</code>)</p>
</li>
<li>
<p>array (an ordered, sequence of values)</p>
</li>
<li>
<p>object (an unordered collection of key value pairs)</p>
</li>
<li>
<p>null</p>
</li>
<li>
<p>expression (denoted by <code>&amp;expression</code>)</p>
</li>
</ul>
<p>Function signatures can now be specified using this new <code>expression</code> type.
Additionally, a function signature can specify the return type of the
expression.  Similarly how arrays can specify a type within a list using the
<code>array[type]</code> syntax, expressions can specify their resolved type using
<code>expression-&gt;type</code> syntax.</p>
<p>Note that any valid expression is allowed after <code>&amp;</code>, so the following
expressions are valid:</p>
<pre><code>sort_by(people, &amp;foo.bar.baz)
sort_by(people, &amp;foo.bar[0].baz)
sort_by(people, &amp;to_number(foo[0].bar))
</code></pre>
<h3 id="additional-functions"><a class="header" href="#additional-functions">Additional Functions</a></h3>
<p>The following functions will be added:</p>
<h4 id="sort_by"><a class="header" href="#sort_by">sort_by</a></h4>
<pre><code>sort_by(array elements, expression-&gt;number|expression-&gt;string expr)
</code></pre>
<p>Sort an array using an expression <code>expr</code> as the sort key.
Below are several examples using the <code>people</code> array (defined above) as the
given input.  <code>sort_by</code> follows the same sorting logic as the <code>sort</code>
function.</p>
<h4 id="examples"><a class="header" href="#examples">Examples</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody>
<tr><td><code>sort_by(people, &amp;age)[].age</code></td><td>[10, 20, 30, 40, 50]</td></tr>
<tr><td><code>sort_by(people, &amp;age)[0]</code></td><td>{&quot;age&quot;: 10, &quot;age_str&quot;: &quot;10&quot;, &quot;bool&quot;: true, &quot;name&quot;: 3}</td></tr>
<tr><td><code>sort_by(people, &amp;to_number(age_str))[0]</code></td><td>{&quot;age&quot;: 10, &quot;age_str&quot;: &quot;10&quot;, &quot;bool&quot;: true, &quot;name&quot;: 3}</td></tr>
</tbody></table>
</div>
<h4 id="max_by"><a class="header" href="#max_by">max_by</a></h4>
<pre><code>max_by(array elements, expression-&gt;number expr)
</code></pre>
<p>Return the maximum element in an array using the expression <code>expr</code> as the
comparison key.  The entire maximum element is returned.
Below are several examples using the <code>people</code> array (defined above) as the
given input.</p>
<h4 id="examples-1"><a class="header" href="#examples-1">Examples</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody>
<tr><td><code>max_by(people, &amp;age)</code></td><td>{&quot;age&quot;: 50, &quot;age_str&quot;: &quot;50&quot;, &quot;bool&quot;: false, &quot;name&quot;: &quot;d&quot;}</td></tr>
<tr><td><code>max_by(people, &amp;age).age</code></td><td>50</td></tr>
<tr><td><code>max_by(people, &amp;to_number(age_str))</code></td><td>{&quot;age&quot;: 50, &quot;age_str&quot;: &quot;50&quot;, &quot;bool&quot;: false, &quot;name&quot;: &quot;d&quot;},</td></tr>
<tr><td><code>max_by(people, &amp;age_str)</code></td><td>&lt;error: invalid-type&gt;</td></tr>
<tr><td><code>max_by(people, age)</code></td><td>&lt;error: invalid-type&gt;</td></tr>
</tbody></table>
</div>
<h4 id="min_by"><a class="header" href="#min_by">min_by</a></h4>
<pre><code>min_by(array elements, expression-&gt;number expr)
</code></pre>
<p>Return the minimum element in an array using the expression <code>expr</code> as the
comparison key.  The entire maximum element is returned.
Below are several examples using the <code>people</code> array (defined above) as the
given input.</p>
<h4 id="examples-2"><a class="header" href="#examples-2">Examples</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody>
<tr><td><code>min_by(people, &amp;age)</code></td><td>{&quot;age&quot;: 10, &quot;age_str&quot;: &quot;10&quot;, &quot;bool&quot;: true, &quot;name&quot;: 3}</td></tr>
<tr><td><code>min_by(people, &amp;age).age</code></td><td>10</td></tr>
<tr><td><code>min_by(people, &amp;to_number(age_str))</code></td><td>{&quot;age&quot;: 10, &quot;age_str&quot;: &quot;10&quot;, &quot;bool&quot;: true, &quot;name&quot;: 3}</td></tr>
<tr><td><code>min_by(people, &amp;age_str)</code></td><td>&lt;error: invalid-type&gt;</td></tr>
<tr><td><code>min_by(people, age)</code></td><td>&lt;error: invalid-type&gt;</td></tr>
</tbody></table>
</div>
<h3 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h3>
<p>There were a number of alternative proposals considered.  Below outlines several of these alternatives.</p>
<h4 id="logic-in-argument-resolver"><a class="header" href="#logic-in-argument-resolver">Logic in Argument Resolver</a></h4>
<p>The first proposed choice (which was originally in JEP-3 but later removed) was
to not have any syntactic construct for specifying functions, and to allow the
function signature to dictate whether or not an argument was resolved.  The
signature for <code>sort_by</code> would be:</p>
<pre><code>sort_by(array arg1, any arg2)
arg1 -&gt; resolved
arg2 -&gt; not resolved
</code></pre>
<p>Then the argument resolver would introspect the argument specification of a
function to determine what to do.  Roughly speaking, the pseudocode would be:</p>
<pre><code>call-function(current-data)
arglist = []
for each argspec in functions-argspec:
    if argspect.should_resolve:
      arglist &lt;- resolve(argument, current-data)
    else
      arglist &lt;- argument
type-check(arglist)
return invoke-function(arglist)
</code></pre>
<p>However, there are several reasons not to do this:</p>
<ul>
<li>
<p>This imposes a specific implementation.  This implementation would be
challenging in a bytecode VM, as the CALL bytecode will typically
resolve arguments onto the stack and allow the function to then
pop arguments off the stack and perform its own arity validation.</p>
</li>
<li>
<p>This deviates from the “standard” model of how functions are
traditionally implemented.</p>
</li>
</ul>
<h4 id="specifying-expressions-as-strings"><a class="header" href="#specifying-expressions-as-strings">Specifying Expressions as Strings</a></h4>
<p>Another proposed alternative was to allow the expression to be
a string type and to give functions the capability to parse/eval
expressions.  The <code>sort_by</code> function would look like this:</p>
<pre><code>sort_by(people, `age`)
sort_by(people, `foo.bar.baz`)
</code></pre>
<p>The main reasons this proposal was not chosen was because:</p>
<ul>
<li>
<p>This complicates the implementations.  For implementations that walk the AST
inline, this means AST nodes need access to the parser.  For external tree
visitors, the visitor needs access to the parser.</p>
</li>
<li>
<p>This moves what <em>could</em> by a compile time error into a run time error.  The
evaluation of the expression string happens when the function is invoked.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0007-filter-expressions.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="0009-improved.filters.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0007-filter-expressions.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="0009-improved.filters.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
