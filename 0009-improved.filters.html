<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0009-improved.filters - JMESPath Enhancement Proposals</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="overview.html">Overview</a></li><li class="chapter-item expanded affix "><a href="0001-nested-expressions.html">0001-nested-expressions</a></li><li class="chapter-item expanded affix "><a href="0003-functions.html">0003-functions</a></li><li class="chapter-item expanded affix "><a href="0004-pipes.html">0004-pipes</a></li><li class="chapter-item expanded affix "><a href="0005-array-slices.html">0005-array-slices</a></li><li class="chapter-item expanded affix "><a href="0006-improved-identifiers.html">0006-improved-identifiers</a></li><li class="chapter-item expanded affix "><a href="0007-filter-expressions.html">0007-filter-expressions</a></li><li class="chapter-item expanded affix "><a href="0008-exptype.html">0008-exptype</a></li><li class="chapter-item expanded affix "><a href="0009-improved.filters.html" class="active">0009-improved.filters</a></li><li class="chapter-item expanded affix "><a href="0010-slice-projects.html">0010-slice-projects</a></li><li class="chapter-item expanded affix "><a href="0011-let-function.html">0011-let-function</a></li><li class="chapter-item expanded affix "><a href="0012-raw-string-literals.html">0012-raw-string-literals</a></li><li class="chapter-item expanded affix "><a href="0018-lexical-scope.html">0018-lexical-scope</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">JMESPath Enhancement Proposals</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="improved-filters"><a class="header" href="#improved-filters">Improved Filters</a></h1>
<ul>
<li>JEP: 9</li>
<li>Author: James Saryerwinnie</li>
<li>Created: 2014-07-07</li>
</ul>
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>JEP 7 introduced filter expressions, which is a mechanism to allow
list elements to be selected based on matching an expression against
each list element.  While this concept is useful, the actual comparator
expressions were not sufficiently capable to accomodate a number of common
queries.  This JEP expands on filter expressions by proposing support for
<code>and-expressions</code>, <code>not-expression</code>, <code>paren-expressions</code>, and
<code>unary-expressions</code>.  With these additions, the capabilities of a filter
expression now allow for sufficiently powerful queries to handle the majority
of queries.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>JEP 7 introduced filter queries, that essentially look like this:</p>
<pre><code>foo[?lhs omparator rhs]
</code></pre>
<p>where the left hand side (lhs)  and the right hand side (rhs)
are both an <code>expression</code>, and comparator is one of
<code>==, !=, &lt;, &lt;=, &gt;, &gt;=</code>.</p>
<p>This added a useful feature to JMESPath: the ability to filter
a list based on evaluating an expression against each element in a list.</p>
<p>In the time since JEP 7 has been part of JMESPath, a number of cases have been
pointed out in which filter expressions cannot solve.  Below are examples of
each type of missing features.</p>
<h3 id="or-expressions"><a class="header" href="#or-expressions">Or Expressions</a></h3>
<p>First, users want the ability to filter based on matching one or more
expressions.  For example, given:</p>
<pre><code>{
  &quot;cities&quot;: [
    {&quot;name&quot;: &quot;Seattle&quot;, &quot;state&quot;: &quot;WA&quot;},
    {&quot;name&quot;: &quot;Los Angeles&quot;, &quot;state&quot;: &quot;CA&quot;},
    {&quot;name&quot;: &quot;Bellevue&quot;, &quot;state&quot;: &quot;WA&quot;},
    {&quot;name&quot;: &quot;New York&quot;, &quot;state&quot;: &quot;NY&quot;},
    {&quot;name&quot;: &quot;San Antonio&quot;, &quot;state&quot;: &quot;TX&quot;},
    {&quot;name&quot;: &quot;Portland&quot;, &quot;state&quot;: &quot;OR&quot;}
  ]
}
</code></pre>
<p>a user might want to select locations on the west coast, which in
this specific example means cities in either <code>WA</code>, <code>OR</code>, or
<code>CA</code>.  It’s not possible to express this as a filter expression
given the grammar of <code>expression comparator expression</code>.  Ideally
a user should be able to use:</p>
<pre><code>cities[?state == `WA` || state == `OR` || state == `CA`]
</code></pre>
<p>JMESPath already supports Or expressions, just not in the context
of filter expressions.</p>
<h3 id="and-expressions"><a class="header" href="#and-expressions">And Expressions</a></h3>
<p>The next missing feature of filter expressions is support for And
expressions.  It’s actually somewhat odd that JMESPath has support
for Or expressions, but not for And expressions.  For example,
given a list of user accounts with permissions:</p>
<pre><code>{
  &quot;users&quot;: [
    {&quot;name&quot;: &quot;user1&quot;, &quot;type&quot;: &quot;normal&quot;&quot;, &quot;allowed_hosts&quot;: [&quot;a&quot;, &quot;b&quot;]},
    {&quot;name&quot;: &quot;user2&quot;, &quot;type&quot;: &quot;admin&quot;, &quot;allowed_hosts&quot;: [&quot;a&quot;, &quot;b&quot;]},
    {&quot;name&quot;: &quot;user3&quot;, &quot;type&quot;: &quot;normal&quot;, &quot;allowed_hosts&quot;: [&quot;c&quot;, &quot;d&quot;]},
    {&quot;name&quot;: &quot;user4&quot;, &quot;type&quot;: &quot;admin&quot;, &quot;allowed_hosts&quot;: [&quot;c&quot;, &quot;d&quot;]},
    {&quot;name&quot;: &quot;user5&quot;, &quot;type&quot;: &quot;normal&quot;, &quot;allowed_hosts&quot;: [&quot;c&quot;, &quot;d&quot;]},
    {&quot;name&quot;: &quot;user6&quot;, &quot;type&quot;: &quot;normal&quot;, &quot;allowed_hosts&quot;: [&quot;c&quot;, &quot;d&quot;]}
  ]
}
</code></pre>
<p>We’d like to find admin users that have permissions to the host named
<code>c</code>.  Ideally, the filter expression would be:</p>
<pre><code>users[?type == `admin` &amp;&amp; contains(allowed_hosts, `c`)]
</code></pre>
<h3 id="unary-expressions"><a class="header" href="#unary-expressions">Unary Expressions</a></h3>
<p>Think of an if statement in a language such as C or Java.  While you can write
an if statement that looks like:</p>
<pre><code>if (foo == bar) { ... }
</code></pre>
<p>You can also use a unary expression such as:</p>
<pre><code>if (allowed_access) { ... }
</code></pre>
<p>or:</p>
<pre><code>if (!allowed_access) { ... }
</code></pre>
<p>Adding support for unary expressions brings a natural syntax when filtering
against boolean values.  Instead of:</p>
<pre><code>foo[?boolean_var == `true`]
</code></pre>
<p>a user could instead use:</p>
<pre><code>foo[?boolean_var]
</code></pre>
<p>As a more realistic example, given a slightly different structure
for the <code>users</code> data above:</p>
<pre><code>{
  &quot;users&quot;: [
    {&quot;name&quot;: &quot;user1&quot;, &quot;is_admin&quot;: false, &quot;disabled&quot;: false},
    {&quot;name&quot;: &quot;user2&quot;, &quot;is_admin&quot;: true, &quot;disabled&quot;: true},
    {&quot;name&quot;: &quot;user3&quot;, &quot;is_admin&quot;: false, &quot;disabled&quot;: false},
    {&quot;name&quot;: &quot;user4&quot;, &quot;is_admin&quot;: true, &quot;disabled&quot;: false},
    {&quot;name&quot;: &quot;user5&quot;, &quot;is_admin&quot;: false, &quot;disabled&quot;: true},
    {&quot;name&quot;: &quot;user6&quot;, &quot;is_admin&quot;: false, &quot;disabled&quot;: false}
  ]
}
</code></pre>
<p>If we want to get the names of all admin users whose account is enabled, we
could either say:</p>
<pre><code>users[?is_admin == `true` &amp;&amp; disabled == `false]
</code></pre>
<p>but it’s more natural and succinct to instead say:</p>
<pre><code>users[?is_admin &amp;&amp; !disabled]
</code></pre>
<p>A case can be made that this syntax is not strictly necessary.  This is true.
However, the main reason for adding support for unary expressions in a filter
expression is users expect this syntax, and are surprised when this is not
a supported syntax.  Especially now that we are basically anchoring to
a C-like syntax for filtering in this JEP, users will expect unary expressions
even more.</p>
<h3 id="paren-expressions"><a class="header" href="#paren-expressions">Paren Expressions</a></h3>
<p>Once <code>||</code> and <code>&amp;&amp;</code> statements have been introduced, there will be times
when you want to override the precedence of these operators.</p>
<p>A <code>paren-expression</code> allows a user to override the precedence order of
an expression, e.g. <code>(a || b) &amp;&amp; c</code>, instead of the default precedence
of <code>a || (b &amp;&amp; c)</code> for the expression <code>a || b &amp;&amp; c</code>.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<p>There are several updates to the grammar:</p>
<pre><code>and-expression         = expression &quot;&amp;&amp;&quot; expression
not-expression         = &quot;!&quot; expression
paren-expression       = &quot;(&quot; expression &quot;)&quot;
</code></pre>
<p>Additionally, the <code>filter-expression</code> rule is updated
to be more general:</p>
<pre><code>bracket-specifier      =/ &quot;[?&quot; expression &quot;]&quot;
</code></pre>
<p>The <code>list-filter-expr</code> is now a more general
<code>comparator-expression</code>:</p>
<pre><code>comparator-expression  = expression comparator expression
</code></pre>
<p>which is now just an expression:</p>
<pre><code>expression /= comparator-expression
</code></pre>
<p>And finally, the <code>current-node</code> is now allowed as a generic
expression:</p>
<pre><code>expression /= current-node
</code></pre>
<h3 id="operator-precedence"><a class="header" href="#operator-precedence">Operator Precedence</a></h3>
<p>This JEP introduces and expressions, which would normally be defined as:</p>
<pre><code>expression     = or-expression / and-expression / not-expression
or-expression  = expression &quot;||&quot; expression
and-expression = expression &quot;&amp;&amp;&quot; expression
not-expression = &quot;!&quot; expression
</code></pre>
<p>However, if this current pattern is followed, it makes it impossible to parse
an expression with the correct precedence.  A more standard way of expressing
this would be:</p>
<pre><code>expression          = or-expression
or-expression       = and-expression &quot;||&quot; and-expression
and-expression      = not-expression &quot;&amp;&amp;&quot; not-expression
not-expression      = &quot;!&quot; expression
</code></pre>
<p>The precedence for the new boolean expressions matches how most
other languages define boolean expressions.  That is from weakest
binding to tightest binding:</p>
<ul>
<li>
<p>Or - <code>||</code></p>
</li>
<li>
<p>And - <code>&amp;&amp;</code></p>
</li>
<li>
<p>Unary not - <code>!</code></p>
</li>
</ul>
<p>So for example, <code>a || b &amp;&amp; c</code> is parsed as <code>a || (b &amp;&amp; c)</code> and
not <code>(a || b) &amp;&amp; c</code>.</p>
<p>The operator precedence list in the specification will now read:</p>
<ul>
<li>
<p>Pipe - <code>|</code></p>
</li>
<li>
<p>Or - <code>||</code></p>
</li>
<li>
<p>And - <code>&amp;&amp;</code></p>
</li>
<li>
<p>Unary not - <code>!</code></p>
</li>
<li>
<p>Rbracket - <code>]</code></p>
</li>
</ul>
<p>Now that these expressions are allowed as general <code>expressions</code>, there
semantics outside of their original contexts must be defined.</p>
<h3 id="and-expressions-1"><a class="header" href="#and-expressions-1">And Expressions</a></h3>
<p>For reference, the JMESPath spec already defines the following values
as “false-like” values:</p>
<ul>
<li>
<p>Empty list: <code>[]</code></p>
</li>
<li>
<p>Empty object: <code>{}</code></p>
</li>
<li>
<p>Empty string: <code>&quot;&quot;</code></p>
</li>
<li>
<p>False boolean: <code>false</code></p>
</li>
<li>
<p>Null value: <code>null</code></p>
</li>
</ul>
<p>And any value that is not a false-like value is a truth-like value.</p>
<p>An <code>and-expression</code> has similar semantics to and expressions in other
languages.  If the expression on the left hand side is a truth-like value, then
the value on the right hand side is returned.  Otherwise the result of the
expression on the left hand side is returned.  This also reduces to the
expected truth table:</p>
<h3 id="truth-table-for-and-expressions"><a class="header" href="#truth-table-for-and-expressions">Truth table for and expressions</a></h3>
<div class="table-wrapper"><table><thead><tr><th>LHS</th><th>RHS</th><th>Result</th></tr></thead><tbody>
<tr><td>True</td><td>True</td><td>True</td></tr>
<tr><td>True</td><td>False</td><td>False</td></tr>
<tr><td>False</td><td>True</td><td>False</td></tr>
<tr><td>False</td><td>False</td><td>False</td></tr>
</tbody></table>
</div>
<p>This is the standard truth table for a
<a href="https://en.wikipedia.org/wiki/Truth_table#Logical_conjunction_.28AND.29">logical conjunction (AND)</a>.</p>
<p>Below are a few examples of and expressions:</p>
<h4 id="examples"><a class="header" href="#examples">Examples</a></h4>
<pre><code>search(True &amp;&amp; False, {&quot;True&quot;: true, &quot;False&quot;: false}) -&gt; false
search(Number &amp;&amp; EmptyList, {&quot;Number&quot;: 5, EmptyList: []}) -&gt; []
search(foo[?a == `1` &amp;&amp; b == `2`],
       {&quot;foo&quot;: [{&quot;a&quot;: 1, &quot;b&quot;: 2}, {&quot;a&quot;: 1, &quot;b&quot;: 3}]}) -&gt; [{&quot;a&quot;: 1, &quot;b&quot;: 2}]
</code></pre>
<h3 id="not-expressions"><a class="header" href="#not-expressions">Not Expressions</a></h3>
<p>A <code>not-expression</code> negates the result of an expression.  If the expression
results in a truth-like value, a <code>not-expression</code> will change this value to
<code>false</code>.  If the expression results in a false-like value, a
<code>not-expression</code> will change this value to <code>true</code>.</p>
<h4 id="examples-1"><a class="header" href="#examples-1">Examples</a></h4>
<pre><code>search(!True, {&quot;True&quot;: true}) -&gt; false
search(!False, {&quot;False&quot;: false}) -&gt; true
search(!Number, {&quot;Number&quot;: 5}) -&gt; false
search(!EmptyList, {&quot;EmptyList&quot;: []}) -&gt; true
</code></pre>
<h3 id="paren-expressions-1"><a class="header" href="#paren-expressions-1">Paren Expressions</a></h3>
<p>A <code>paren-expression</code> allows a user to override the precedence order of
an expression, e.g. <code>(a || b) &amp;&amp; c</code>.</p>
<h4 id="examples-2"><a class="header" href="#examples-2">Examples</a></h4>
<pre><code>search(foo[?(a == `1` || b ==`2`) &amp;&amp; c == `5`],
       {&quot;foo&quot;: [{&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: 3}, {&quot;a&quot;: 3, &quot;b&quot;: 4}]}) -&gt; []
</code></pre>
<h2 id="rationale"><a class="header" href="#rationale">Rationale</a></h2>
<p>This JEP brings several tokens that were only allowed in specific constructs
into the more general <code>expression</code> rule.  Specifically:</p>
<ul>
<li>
<p>The <code>current-node</code> (<code>@</code>) was previously only allowed in function
expressions, but is now allowed as a general <code>expression</code>.</p>
</li>
<li>
<p>The <code>filter-expression</code> now accepts any arbitrary <code>expression</code>.</p>
</li>
<li>
<p>The <code>list-filter-expr</code> is now just a generic <code>comparator-expression</code>,
which again is just a general <code>expression</code>.</p>
</li>
</ul>
<p>There are several reasons the previous grammar rules were minimally scoped.
One of the main reasons, as stated in JEP 7 which introduced filter
expressions, was to keep the spec “purposefully minimal.”  In fact the end
of JEP 7 states that there “are several extensions that can be added in
future.” This is in fact exactly what this JEP proposes, the recommendations
from JEP 7.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0008-exptype.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="0010-slice-projects.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0008-exptype.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="0010-slice-projects.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
